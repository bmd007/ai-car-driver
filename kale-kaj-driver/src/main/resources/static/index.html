<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kale Kaj Brain</title>
    <style>
        #main-container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 32px;
            margin: 30px;
        }

        @media (max-width: 900px) {
            #main-container {
                flex-direction: column;
                gap: 0;
            }

            #chat-panel {
                margin-top: 24px;
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
<div id="main-container">
    <div id="video-frame3" style="border: 8px solid green; padding: 4px; background: #eaffea;">
        <img id="video-stream3" src="https://kalekaj-bmd.eu1.pitunnel.net/v3/video-stream"
             style="max-width: 600px; max-height: 600px;" alt="Live Video Stream">
    </div>

    <div id="chat-panel"
         style="border: 8px solid #4e9a06; background: #f6fff6; border-radius: 16px; box-shadow: 0 4px 24px rgba(78,154,6,0.15); max-width: 600px; padding: 24px;">
        <h2 style="color: #4e9a06; margin-bottom: 16px; font-family: 'Segoe UI', sans-serif;">ü§ñ AI Chat Panel</h2>
        <div id="chat-output"
             style="height: 320px; overflow-y: auto; background: #eaffea; border-radius: 8px; padding: 16px; font-size: 1.1em; color: #222; margin-bottom: 18px; box-shadow: 0 2px 8px rgba(78,154,6,0.07);"></div>
        <div style="display: flex; gap: 12px;">
            <input id="chat-input" type="text" placeholder="Type your message..."
                   style="flex: 1; padding: 12px; border-radius: 8px; border: 2px solid #4e9a06; font-size: 1em; outline: none;">
            <button id="chat-send"
                    style="background: linear-gradient(90deg,#4e9a06 60%,#8ae234 100%); color: white; border: none; border-radius: 8px; padding: 0 24px; font-size: 1em; font-weight: bold; cursor: pointer; box-shadow: 0 2px 8px rgba(78,154,6,0.12); transition: background 0.2s;">
                Send
            </button>
        </div>
    </div>
</div>

<script>
    const chatOutput = document.getElementById('chat-output');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');

    function appendToOutput(text) {
        chatOutput.textContent += text;
        chatOutput.scrollTop = chatOutput.scrollHeight;
    }

    async function startChatStream(input) {
        chatOutput.textContent = '';
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Accept': 'text/event-stream'},
            body: JSON.stringify({input})
        });

        if (!response.body) {
            appendToOutput('‚ö†Ô∏è No response stream.');
            return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
            const {value, done} = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, {stream: true});
            let lines = buffer.split('\n');
            buffer = lines.pop();
            for (const line of lines) {
                if (line.startsWith('data:')) {
                    appendToOutput(line.slice(5) + ' ');
                }
            }
        }
    }

    chatSend.onclick = async function () {
        const input = chatInput.value.trim();
        if (!input) return;
        chatSend.disabled = true;
        chatInput.disabled = true;
        await startChatStream(input);
        chatSend.disabled = false;
        chatInput.disabled = false;
        chatInput.value = '';
    };

    chatInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') chatSend.click();
    });

    document.getElementById('video-stream3')
        .addEventListener('error', function () {
            setTimeout(function () {
                const img = document.getElementById('video-stream3');
                img.src = 'v3/video-stream?ts=' + Date.now();
            }, 1000);
        });
</script>

</body>
</html>
